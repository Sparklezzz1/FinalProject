{% extends 'base.html' %}
{% load i18n %}
{% block content %}
<div class="container mt-5 mb-5">
    <div class="mx-auto" style="max-width: 400px;">

        <h2 class="text-center mb-4">
            {% trans "Запись на приём" %}
        </h2>

        <form method="post" id="appointment-form">
            {% csrf_token %}
            
            {# Поле выбора услуги #}
            <div class="mb-3">
                <label for="id_services" class="form-label">{% trans "Услуга" %}</label>
                {{ form.services }}
            </div>

            {# Новое поле выбора врача #}
            <div class="mb-3">
                <label for="id_doctor" class="form-label">{% trans "Врач" %}</label>
                <select name="doctor" id="id_doctor" class="form-select" disabled>
                    <option value="">{% trans "Сначала выберите услугу" %}</option>
                </select>
            </div>

            {# Остальные поля формы (имя, фамилия, дата, время и т.д.) #}
          {% for field in form %}
    {% if field.name not in 'services doctor' %}
        <div class="mb-3">
            {{ field.label_tag }}
            {{ field }}
            {% for error in field.errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endfor %}

            <button type="submit" class="btn btn-primary btn-sm w-100 mb-3">
                {% trans "Сохранить данные" %}
            </button>
        </form>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const serviceSelect = document.getElementById('id_services');
    const doctorSelect = document.getElementById('id_doctor');

    serviceSelect.addEventListener('change', function() {
        const serviceId = this.value;
        doctorSelect.innerHTML = '<option>{% trans "Загрузка..." %}</option>';
        doctorSelect.disabled = true;

        if (!serviceId) {
            doctorSelect.innerHTML = '<option>{% trans "Сначала выберите услугу" %}</option>';
            return;
        }

        fetch(`/get-doctors/?service_id=${serviceId}`)
            .then(response => response.json())
            .then(data => {
                doctorSelect.innerHTML = '';
                if (data.length === 0) {
                    doctorSelect.innerHTML = '<option>{% trans "Нет доступных врачей" %}</option>';
                } else {
                    data.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.id;
                        option.textContent = doctor.full_name;
                        doctorSelect.appendChild(option);
                    });
                }
                doctorSelect.disabled = false;
            })
            .catch(() => {
                doctorSelect.innerHTML = '<option>{% trans "Ошибка загрузки" %}</option>';
            });
    });
});
</script>
{% endblock %}